variables:
     APP_VERSION: "2.1.0"
     API_VERSION: "2.1.0"
     K8S_DEPLOYMENT: "1"
     CICD_SCRIPTS_ROOT_PATH: "/home/gitlab-runner/ci_cd"
     BUILD_SCRIPTS_ROOT_PATH: "$CICD_SCRIPTS_ROOT_PATH/standalone"
workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == "test" || $CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "staging" || $CI_COMMIT_BRANCH == "development" || $CI_COMMIT_BRANCH == "migration"
stages:
  - configure
  - build
  - update_server
  - deploy
  - build_docker
  - deploy_docker
  - build_sif
  - deploy_workers


checkout_configs:
  stage: configure
  rules:
    - if: $K8S_DEPLOYMENT == "1"
      variables:
        BUILD_SCRIPTS_ROOT_PATH: $CICD_SCRIPTS_ROOT_PATH/k8s
  script:
    - bash "$BUILD_SCRIPTS_ROOT_PATH/checkout_configs.sh"

build_docker:
  stage: build_docker
  rules:
    - if: $K8S_DEPLOYMENT == "1"
      variables:
        BUILD_SCRIPTS_ROOT_PATH: $CICD_SCRIPTS_ROOT_PATH/k8s
  script:
    - bash "$BUILD_SCRIPTS_ROOT_PATH/mtblsws-py/build_container.sh"

build_singularity:
  stage: build_sif
  rules:
    - if: $K8S_DEPLOYMENT == "1"
      variables:
        BUILD_SCRIPTS_ROOT_PATH: $CICD_SCRIPTS_ROOT_PATH/k8s
  script:
    - bash "$BUILD_SCRIPTS_ROOT_PATH/mtblsws-py/build_sif.sh"

deploy_ws_on_k8s:
  stage: deploy_workers
  rules:
    - if: $K8S_DEPLOYMENT == "1"
      when: manual
      allow_failure: true
      variables:
        BUILD_SCRIPTS_ROOT_PATH: $CICD_SCRIPTS_ROOT_PATH/k8s
  script:
    - bash "$BUILD_SCRIPTS_ROOT_PATH/mtblsws-py/deploy_ws.sh"

deploy_datamover_worker_on_k8s:
  stage: deploy_workers
  rules:
    - if: $K8S_DEPLOYMENT == "1"
      when: manual
      allow_failure: true
      variables:
        BUILD_SCRIPTS_ROOT_PATH: $CICD_SCRIPTS_ROOT_PATH/k8s
  script:
    - bash "$BUILD_SCRIPTS_ROOT_PATH/mtblsws-py/deploy_datamover_worker.sh"

deploy_common_worker_on_k8s:
  stage: deploy_workers
  rules:
    - if: $K8S_DEPLOYMENT == "1"
      when: manual
      allow_failure: true
      variables:
        BUILD_SCRIPTS_ROOT_PATH: $CICD_SCRIPTS_ROOT_PATH/k8s
  script:
    - bash "$BUILD_SCRIPTS_ROOT_PATH/mtblsws-py/deploy_common_worker.sh"

deploy_beat_on_k8s:
  stage: deploy_workers
  rules:
    - if: $K8S_DEPLOYMENT == "1"
      when: manual
      allow_failure: true
      variables:
        BUILD_SCRIPTS_ROOT_PATH: $CICD_SCRIPTS_ROOT_PATH/k8s
  script:
    - bash "$BUILD_SCRIPTS_ROOT_PATH/mtblsws-py/deploy_beat.sh"

# standalone build

standalone_build_docker:
  stage: build
  rules:
    - if: $K8S_DEPLOYMENT != "1"
  script:
    - bash "$BUILD_SCRIPTS_ROOT_PATH/mtblsws-py/build_container.sh"
    - bash "$BUILD_SCRIPTS_ROOT_PATH/mtblsws-py/build_sif.sh"
    
standalone_configure_vm_server:
  stage: update_server
  rules:
    - if: $K8S_DEPLOYMENT != "1"
  script:
    - bash "$BUILD_SCRIPTS_ROOT_PATH/mtblsws-py/update_server.sh"
    - bash "$BUILD_SCRIPTS_ROOT_PATH/mtblsws-py/update_version_files.sh"
    
standalone_configure_datamover:
  stage: update_server
  rules:
  - if: $K8S_DEPLOYMENT != "1"
  script:
    - bash "$BUILD_SCRIPTS_ROOT_PATH/mtblsws-py/update_datamover.sh"

standalone_run_server:
  stage: deploy
  rules:
    - if: $K8S_DEPLOYMENT != "1"
    - if: $CI_COMMIT_BRANCH == "master" && $K8S_DEPLOYMENT != "1"
      when: manual
      allow_failure: false
    - if: $CI_COMMIT_BRANCH == "staging" && $K8S_DEPLOYMENT != "1"
      when: on_success
    - if: $CI_COMMIT_BRANCH == "test" && $K8S_DEPLOYMENT != "1"
      when: on_success
    - if: $CI_COMMIT_BRANCH == "development" && $K8S_DEPLOYMENT != "1"
      when: on_success
  script:
    - bash "$BUILD_SCRIPTS_ROOT_PATH/mtblsws-py/restart_server.sh"
    - bash "$BUILD_SCRIPTS_ROOT_PATH/mtblsws-py/restart_datamover.sh"

standalone_deploy_additional_servers:
  rules:
    - if: $K8S_DEPLOYMENT != "1"
    - if: $CI_COMMIT_BRANCH == "master"
      when: manual
      allow_failure: true
    - when: never
  stage: deploy
  script:
    - bash "$BUILD_SCRIPTS_ROOT_PATH/mtblsws-py/restart_additional_servers.sh"
