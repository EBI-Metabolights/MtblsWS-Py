#!/bin/bash

REMOTE_SERVER_BASE_PATH="{{ REMOTE_SERVER_BASE_PATH }}"
export PYTHON_WEB_FOLDER="MtblsWS-Py"
export SINGULARITY_FOLDER="$REMOTE_SERVER_BASE_PATH/Singularity"

export SINGULARITY_LOCALCACHEDIR="$SINGULARITY_FOLDER/cache"
export SINGULARITY_CACHEDIR="$SINGULARITY_FOLDER/cache"
export SINGULARITY_TMPDIR="$SINGULARITY_FOLDER/builds"
export DEFAULT_LOCAL_FILE="$SINGULARITY_FOLDER/default.local"

mkdir -p $SINGULARITY_LOCALCACHEDIR
mkdir -p $SINGULARITY_CACHEDIR
mkdir -p $SINGULARITY_TMPDIR
mkdir -p $DEFAULT_LOCAL_FILE

SINGULARITY_IMAGE_DESCRIPTOR="$SINGULARITY_FOLDER/{{ SINGULARITY_IMAGE_DESCRIPTOR }}"
SINGULARITY_IMAGE="${SINGULARITY_FOLDER}/$(cat $SINGULARITY_IMAGE_DESCRIPTOR)"
APP_ROOT="{{ DOCKER_APP_ROOT }}"
START_COMMAND="{{ DOCKER_BOOTSTRAP_COMMAND }} ${LSB_JOBNAME} {{ DOCKER_BOOTSTRAP_COMMAND_ARGUMENTS }}" 

# BIND PATHS
CONFIG_FILE_PATH="$REMOTE_SERVER_BASE_PATH/$PYTHON_WEB_FOLDER/config.yaml"
SECRETS_PATH="$REMOTE_SERVER_BASE_PATH/$PYTHON_WEB_FOLDER/.secrets"
LOGS_PATH="$REMOTE_SERVER_BASE_PATH/$PYTHON_WEB_FOLDER/logs"

mkdir -p $LOGS_PATH

HOME_DIR="{{ HOME_DIR }}"
HOME_DIR_MOUNT_PATH="{{ HOME_DIR_MOUNT_PATH }}"
BINDINGS=()

BINDINGS+=("$CONFIG_FILE_PATH:$APP_ROOT/config.yaml")
BINDINGS+=("$SECRETS_PATH:$APP_ROOT/.secrets")
BINDINGS+=("$LOGS_PATH:$APP_ROOT/logs")
BINDINGS+=("{{ HOME_DIR }}:{{ HOME_DIR_MOUNT_PATH }}")

{% for SHARED_PATH in SHARED_PATHS %} 
BINDINGS+=("{{ SHARED_PATH }}:{{ SHARED_PATH }}")
{% endfor %}

function join { local IFS="$1"; shift; echo "$*"; }

BIND_PARAMS=$(join "|" "${BINDINGS[@]}")
BIND_PARAMS=$(echo "$BIND_PARAMS" | sed "s/|/ -B /g")
if [ ! -z "!BIND_PARAMS" ]; then
    BIND_PARAMS="-B $BIND_PARAMS"
fi

# ENVIRONMENT VARIABLES
ENVIRONMENT_PARAMS="--env PYTHONPATH=$APP_ROOT --env CONFIG_FILE_PATH=$APP_ROOT/config.yaml --env SECRETS_PATH=$APP_ROOT/.secrets"

# EXECUTE SINGULARITY
singularity exec --writable-tmpfs -H $HOME_DIR ${ENVIRONMENT_PARAMS} ${BIND_PARAMS} "${SINGULARITY_IMAGE}" ${START_COMMAND}